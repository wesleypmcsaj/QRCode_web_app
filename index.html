<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Leitor de QR Code</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script async defer src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <video id="video" width="300" height="200"></video>
    <div id="result"></div>

    <script>
        // Configuração para leitura do QR code
        const codeReader = new ZXing.BrowserQRCodeReader();
        const videoElement = document.getElementById('video');
        const resultElement = document.getElementById('result');

        // Iniciar a leitura do QR code
        codeReader.decodeFromVideoDevice(null, videoElement, (result, error) => {
            if (result) {
                resultElement.textContent = `QR Code Data: ${result.text}`;
                processQRCode(result.text);
            }
            if (error) {
                console.error(error);
            }
        });

        // Processar o QR code e atualizar a planilha
        function processQRCode(qrCodeText) {
            let searchString;
            const currentYear = new Date().getFullYear();

            if (qrCodeText.startsWith('OF')) {
                const parts = qrCodeText.split(' ');
                if (Array.isArray(parts) && parts.length === 2) {
                    const number = parts[1];
                    searchString = `${number}/SAJ/${currentYear}`;
                    updateGoogleSheet(searchString, 1);
                }
            } else if (qrCodeText.startsWith('CI')) {
                const parts = qrCodeText.split(' ');
                if (Array.isArray(parts) && parts.length === 2) {
                    const number = parts[1];
                    searchString = `CI ${number}-SAJ-${currentYear}`;
                    updateGoogleSheet(searchString, 13);
                }
            }
        }

        // Atualizar a planilha Google Sheets
        function updateGoogleSheet(searchString, columnIndex) {
            // Autenticação e configuração da API Google Sheets
            gapi.load('auth2', () => {
                gapi.auth2.init({
                    client_id: '574827934929-r8jul0jgvaerbgg2bhbdknf58g8b4frq.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/spreadsheets',
                }).then(() => {
                    gapi.load('client:auth2', () => {
                        gapi.client.init({
                            apiKey: 'AIzaSyAIqEr2YSsV5sURl35ELRJETCKJYWqQDF0',
                            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                        }).then(() => {
                            const sheets = gapi.client.sheets.spreadsheets.values;
                            const spreadsheetId = '16_zlC5bRdyGTqFcVFvRIBCYzP-fjoPN9i64tD5DGe5c';
                            sheets.get({
                                spreadsheetId: spreadsheetId,
                                range: 'Atual'
                            }).then(response => {
                                if (response && response.result && response.result.values) {
                                    const data = response.result.values;
                                    let rowIndex = -1;

                                    // Encontrar a linha que contém o valor
                                    for (let i = 0; i < data.length; i++) {
                                        if (data[i][columnIndex] === searchString) {
                                            rowIndex = i;
                                            break;
                                        }
                                    }

                                    if (rowIndex !== -1) {
                                        const range = `Atual!A${rowIndex + 1}`;
                                        const row = data[rowIndex];
                                        row[5] = new Date().toLocaleDateString('pt-BR'); // Atualizar "Descida Assinatura"
                                        row[12] = 'CX Aguardando protocolo'; // Atualizar "Caixa/Pasta"
                                        const body = {
                                            values: [row]
                                        };
                                        sheets.update({
                                            spreadsheetId: spreadsheetId,
                                            range: range,
                                            valueInputOption: 'RAW',
                                            resource: body
                                        }).then(() => {
                                            resultElement.textContent = 'Dados atualizados com sucesso!';
                                        }).catch(error => {
                                            console.error('Error updating sheet:', error);
                                            resultElement.textContent = 'Erro ao atualizar os dados.';
                                        });
                                    } else {
                                        resultElement.textContent = 'Dados não encontrados.';
                                    }
                                } else {
                                    console.error('Invalid response from Google Sheets API');
                                    resultElement.textContent = 'Erro ao ler a planilha.';
                                }
                            }).catch(error => {
                                console.error('Error reading sheet:', error);
                                resultElement.textContent = 'Erro ao ler a planilha.';
                            });
                        });
                    });
                });
            });
        }
    </script>
</body>
</html>
