<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de QR Code</title>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        #reader {
            width: 100%;
            height: 100vh;
            background: #000;
        }
    </style>
</head>
<body>
    <div id="reader"></div>
    <script>
        let sheetId = '16_zlC5bRdyGTqFcVFvRIBCYzP-fjoPN9i64tD5DGe5c';
        let apiKey = 'AIzaSyD8BjrZwR13tlF2AGr0Kjcf2g3IkfN2mfU';
        let clientId = '349400116418-aldrjhmj2nvon58f2gv1601el2u9i2ak.apps.googleusercontent.com'; // substitua pelo seu Client ID
        let scope = 'https://www.googleapis.com/auth/spreadsheets';

        function onApiLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                apiKey: apiKey,
                clientId: clientId,
                scope: scope
            }).then(() => {
                gapi.auth2.getAuthInstance().signIn().then(() => {
                    console.log('Autenticado com sucesso');
                });
            });
        }

        async function updateSheet(range, values) {
            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetId,
                    range: range,
                    valueInputOption: 'USER_ENTERED',
                    values: [values]
                });
                console.log(`Dados atualizados com sucesso para: ${range}`);
            } catch (error) {
                console.error(`Erro ao atualizar planilha: ${error}`);
            }
        }

        function handleScan(result) {
            let data = result.text;
            let now = new Date();
            let dateString = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;

            if (data.startsWith('OF')) {
                let parts = data.split(' ');
                let number = parts[1];
                let searchTerm = `${number}/SAJ/${now.getFullYear()}`;
                let range = 'Atual!A:F'; // Ajuste o range conforme necess치rio
                let values = [dateString, 'CX Aguardando protocolo'];

                // Adiciona a l칩gica para buscar e atualizar a planilha
                console.log(`Procurando por: ${searchTerm}`);
                updateSheet(range, values);
            } else if (data.startsWith('CI')) {
                let parts = data.split(' ');
                let number = parts[1];
                let searchTerm = `${number}-SAJ-${now.getFullYear()}`;
                let range = 'Atual!N:P'; // Ajuste o range conforme necess치rio
                let values = [dateString, 'CX aguardando resposta'];

                // Adiciona a l칩gica para buscar e atualizar a planilha
                console.log(`Procurando por: ${searchTerm}`);
                updateSheet(range, values);
            }
        }

        function startScanner() {
            let html5QrCode = new Html5Qrcode("reader");

            html5QrCode.start({ facingMode: "environment" }, {
                fps: 10,
                qrbox: 250
            }, handleScan).catch((error) => {
                console.error(`Erro ao iniciar o scanner: ${error}`);
            });
        }

        startScanner();
        onApiLoad();
    </script>
</body>
</html>
